<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Code Smells - Recognising smelly code</title>

		<meta name="description" content="Presentation about sonar framework for code quality">
		<meta name="author" content="Emilio Rodriguez">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />


		<link rel="stylesheet" href="./reveal.js/css/reveal.min.css">
		<link rel="stylesheet" href="./reveal.js/css/theme/simple.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="./reveal.js/lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet 
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>
		-->

		<style>
			#spil-logo{
				position: absolute;
				top: 0;
				left: 20px;
				max-width: 16%;
			}

			#php-logo{
				position:absolute;
				top:30px;
				right:20px;
				max-width: 8%;
			}
			.big-code {
				
				width: 1246px !important;
				left: -550px !important;
			}
			.big-code code{
				max-height: 700px;
			}
		</style>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<img id="spil-logo" src="./img/spillogo.jpg">
			<img id="php-logo" src="./img/phplogo.png" style="">
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<section>
					<h1>Code Smells</h1>
					<h3>Recognising smelly code</h3>
				</section>
				<section>
						We are going to see a piece of code for 4 seconds.<br>
						Try to understand what it does
				</section>
				<section class="big-code">
						<pre><code contenteditable>
class cheetahClass
{
	public function doStuff()
	{
		$db = $this->getDb();
		$query = 'SELECT email FROM receivers WHERE active = 1';

		$rows = $db->fetchRows($query);
		$addresses = array();

		foreach($rows as $row){
			$addresses[] = trim($row->email);
			if(count($addresses) > 0){
				foreach($addresses as $address){
					$email = new Email();
					$email->to = $address['email'];
					$email->subject = 'test from cheetahmail';
					if(count($address->sites) > 0){
						$email->body = 'You are  in:'. PHP_EOL;
						foreach($address->sites as $site){
							$email->body .= '- ' . $site;
							$email->body .= PHP_EOL;
						}
					}
					$email->body .= PHP_EOL;
					$email->send();
				}

			}
		}
	}
}
					</code></pre>

					</section>
					<section>
						Any clue?
					</section>
					<section>
						<pre><code contenteditable>
class emailManager
{
	public function sendTestEmails()
	{
		$addresses = $this->getTestRecipientEmails();
		$this->sendEmail($addresses);
	}
}
					</code></pre>

					</section>
					<section>
						And now?
					</section>
					<section class="big-code">
						<pre><code contenteditable>
class cheetahClass
{
	public function doStuff()
	{
		$db = $this->getDb();
		$query = 'SELECT email FROM receivers WHERE active = 1';

		$rows = $db->fetchRows($query);
		$addresses = array();

		foreach($rows as $row){
			$addresses[] = trim($row->email);
			if(count($addresses) > 0){
				foreach($addresses as $address){
					$email = new Email();
					$email->to = $address['email'];
					$email->subject = 'test from cheetahmail';
					if(count($address->sites) > 0){
						$email->body = 'You are in:'. PHP_EOL;
						foreach($address->sites as $site){
							$email->body .= '- ' . $site;
							$email->body .= PHP_EOL;
						}						
					}

				}
				$email->body .= PHP_EOL;
				$email->send();
			} 			
		}
	}
}
					</code></pre>

					</section>

<aside class="notes">
	<pre>
		Problems: 
			- Levels of nesting
			- no DB abstraction/no data model
			- Uncommunicative names
	</pre>
</aside>


					<section class="big-code">
						Long methods + Inline Comments
						<pre><code contenteditable>
    public function index($nicename, $page=1)
    {
    	$this->categoryContext = null;
        $category = $this->Categorydetail->findByCategoryNicename($nicename);
        if (!$category) $this->cakeError('404');

        //canonical link
        $url = Router::url();
        $url_parts = explode('/', $url);
        $this->set('canonicalurl', "/" . strtolower($url_parts[1]) . '/' . strtolower($nicename) . '.html');

        // get subcategories box
        $subcategories_all = $this->getSubcategoryBoxes(
            $category['Category']['id']
        );
        // check if it contains subcats
        if (sizeof($subcategories_all)==0) {
            $this->cakeError('404');
        }

        // setting title etc according to seo inclusions
        $this->setMetaData('category', $category);

        //get popular games
        $popularbox = $this->getPopularboxgames(
            Configure::read('popularboxGamesCount'),
            $category['Category']['id']
        );

        // get first hot game box
        $firsthotgamebox = array($popularbox[0]);

        // get hot games box
        $temp = array_shift($popularbox);
        $hotgamesbox = $popularbox;

        $subcategories = array();
        $moresubcategories = array();

        $count = sizeof($subcategories_all);

        // NOW WE USE CMS
        $results = $this->Catconfig->find('all');
        $rules = array();
        $rule = null;
        $default_rule = 12;

        if (!$results) $results = array();

        if (sizeof($results)>0) {
            foreach ($results as $item) {
                if (intval($item['Catconfig']['boxes']) > 0) {
                    $rules[$item['Catconfig']['subcategories']] =
                        $item['Catconfig']['boxes'];
                }
            }
        } else {
            $rules = $this->Catconfig->constructDefaultValues();
        }

        if (array_key_exists($count, $rules)) {
            $rule = $rules[$count];
        } else if (array_key_exists(33, $rules)) {
            $rule = $rules[33]; // >32
        } else {
            $rule = $default_rule;
        }

        $subcategories = array_slice($subcategories_all, 0, $rule);
        $moresubcategories = array_slice($subcategories_all, $rule);

        $subcatmostplayedgames = array();
        // 7 most played games for each subcategory
        foreach ($subcategories_all as $subcategory) {
            $subcatmostplayedgames[$subcategory['Subcategorydetail']['subcategory_nicename']] =
                $this->getSubcategyMostPlayed(
                    Configure::read('subcatboxGamesCount'),
                    $subcategory['Subcategorydetail']['subcategory_id'],
                    $category['Category']['id']
                );
        }

        // delete the <meta> tag if we want to hide the game
        if ($category['Category']['invisible'] == 1) {
        	$this->set('dont_index', true);
        }
        
        $this->set(compact('category', 'page'));

        // site takeover
        $sitetakeover = $this->setTakeover($category['Category']['id']);
        $this->set('sitetakeover', $sitetakeover);

        // extra page codes
        $extrapagecodes = $this->Extracode->prepareAllCodes(
            'category',
            $category['Category']['id']
        );
        $this->set('extrapagecodes', $extrapagecodes);

        $headcodes = $this->Extracode->prepareAllCodes('category', $category['Category']['id'], null, 'head');
        $this->set('headcodes', $headcodes);

        // breadcrumb
        $categorydetail = $category['Categorydetail'];
        $this->setBreadCrumb($categorydetail);

        // leaderboard banner
        if ($sitetakeover === false || !is_array($sitetakeover)) {
             // display ONLY when there's no SITE TAKEOVER
            $leaderboard = $this->getLeaderboardBanner(
                'category',
                $category['Category']['catname_lid']
            );
        } else {
            $leaderboard = false;
        }
        $rect_advert = $this->getRectAdvertBanner(
            'category',
            $category['Category']['catname_lid']
        );
        $this->set('rect_advert', $rect_advert);

        // set rating Weight
        $ratingWeight = $this->ratingWeight;

        //floor ad
        $this->set(
            'floorad', $this->Floorads->getData(
                'categorypage',
                $category['Category']['id']
            )
        );

        // SETS
        $this->set(
            compact(
                'firsthotgamebox', 'categorydetail', 'hotgamesbox',
                'subcategories', 'moresubcategories', 'subcatmostplayedgames',
                'leaderboard', 'ratingWeight'
            )
        );

        //seo content box
        $seocontentboxes = $this->Seocontentbox->find('all',
            array(
                'conditions' => array(
                    'site_id' => $this->site_id,
                    'category_id' => $category['Category']['id'],
                    'subcategory_id' => null,
                    'active' => '1'
                ),
                'order' => array('sort') 
            )
        );
        $this->set('seocontentboxes', $seocontentboxes);
        if($this->inclusions->get('tags', 'config') == 'true') {
            $this->set('tags',$this->GameTag->getTagsByCategoryId($category['Category']['id'], $this->site_id, Configure::read('tags_rows_page') * 4));
        }
        $this->categoryContext .= $seocontentboxes;
    }
<aside class="notes">
	<pre>
		Problems: 
			- Impossible to remember previos context from line 15
			- what does $this->categoryContext contain after 10 lines?
			- Inline comments mark the point where this file can be splitted
	</pre>
</aside>
					</code></pre>

					</section>
				
				<section>
					<h2>Uncommunicative names</h2>
					<p>
						doStuff()&nbsp;&nbsp;&nbsp;&nbsp;vs&nbsp;&nbsp;&nbsp;&nbsp;fetchTheEmailsAndSendInvitations()
					</p>
				</section>

				<section>
					<h2>Communicative names</h2>
					<p>
						fetchEmails()<br/>
						sendInvites()
					</p>
				</section>

				<section>
					<h2>Too many parameters</h2>
					<p>
						function sendEmail($to, $from, $subject, $body, $agent, $images, $cc, $cco, $attachments, $encoding)
					</p>
				</section>

				<section>
					<h2>Too many parameters</h2>
					<p>Pass an object instead:</p>
					<p>
						function sendEmail($email)
					</p>
				</section>

									<section>
						Smells can come also from OO anti-patterns:
						<ul>
							<li> God Object </li>
							<li> Data Class </li>
							<li> Lazy Class </li>
							<li> Tight Coupling </li>
<aside class="notes">
	<pre>
		God Object: 
			- An object does everything and asks for little help (huge controller)
		Data Class:
			- Classes with only getters and setters (data should be moved to whom is nedding it)
		Lazy Class:
			- Small classes not very used. May be moved to an inline class or move it's responsibility
			to more meaningful classes
	</pre>
</aside>
					</section>
					<section>
						<h2>Tight Coupling</h2>
						<pre><code contenteditable>
class HTMLHelper
{
	protected $metaData;
	protected $name;

	public function __construct($pageName, $metaTags)
	{
		$this->metaData = new MetaData($metaTags);
		$this->name = $pageName;
	}

	public function getMetaTags()
	{
		return $this->metaData->getTags();
	}
}
						</code></pre>
<aside class="notes">
	<pre>
		Problem: 
			- impossible to to test because id depends so much on Metatags class
			- this class will have to change if Metatags class changes
		Solution: dependency injection
	</pre>
</aside>
					</section>

				<section>
						<h2>Dependency injection</h2>
						<pre><code contenteditable>
class HTMLHelper
{
	protected $metaData;
	protected $name;

	public function __construct($pageName,MetaData $metaData)
	{
		$this->metaData = $metaData;
		$this->name = $pageName;
	}

	public function getMetaTags()
	{
		return $this->metaData->getTags();
	}
}
						</code></pre>
<aside class="notes">
	<pre>
		Problem: 
			- impossible to to test because id depends so much on Metatags class
			- this class will have to change if Metatags class changes
		Solution: dependency injection
	</pre>
</aside>
					</section>

			</div>

		</div>

		<script src="./reveal.js/lib/js/head.min.js"></script>
		<script src="./reveal.js/js/reveal.min.js"></script>

		<script>
			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'reveal.js/plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

			Reveal.addEventListener( 'slidechanged', function( event ) {
				var currentSlide = Reveal.getIndices();
				if(currentSlide.h === 2 || currentSlide.h === 4){
					window.setTimeout("Reveal.next()", 4000);
				}
			    // event.previousSlide, event.currentSlide, event.indexh, event.indexv
			} );

		</script>

	</body>
</html>
